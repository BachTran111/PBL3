<!DOCTYPE html>
<html lang="vi">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Chi tiết Homestay</title>
        <link rel="stylesheet" href="assets/css/room-detail.css" />
        <link rel="stylesheet" href="assets/css/header.css" />
        <link rel="stylesheet" href="./assets/fonts/themify-icons/themify-icons.css" />
    </head>
    <body>
        <!-- Header -->
        <header>
            <div class="header-container">
                <div class="container">
                    <div class="header-content">
                        <div class="logo">
                            <a href="trang-chu.html">
                                <img class="logo-image" src="assets/img/gotravel_logo_air.png" alt="" />
                            </a>
                        </div>
                        <nav class="nav">
                            <ul>
                                <li><a href="trang-chu.html">TRANG CHỦ</a></li>
                                <li><a href="homestay.html">HOMESTAYS</a></li>
                                <li><a href="about.html" target="_blank">VỀ CHÚNG TÔI</a></li>
                                <li><a href="contact.html" target="_blank">LIÊN HỆ</a></li>
                            </ul>
                        </nav>
                    </div>
                </div>

                <div class="btns desktop-btns" id="auth-buttons">
                    <button class="cooperate-btn" onclick="location.href='partnership.html'">Hợp tác với chúng tôi</button>
                    <button class="dang-ky-btn signup" id="registerBtn">Đăng ký</button>
                    <button class="dang-nhap-btn login" id="loginBtn">Đăng nhập</button>
                </div>

                <div id="user-info" class="user-dropdown" style="display: none; position: relative">
                    <img src="/assets/img/icon/user.svg" alt="user-icon" id="user-icon" />
                    <div id="user-menu" class="dropdown-menu">
                        <a href="#" id="profileLink" class="dropdown-item">Hồ sơ</a>
                        <button id="logoutBtn" class="dropdown-item">Đăng xuất</button>
                    </div>
                </div>

                <button class="mobile-menu-toggle" aria-label="Toggle menu" aria-expanded="false">
                    <i class="ti-menu"></i>
                </button>

                <div class="mobile-menu">
                    <a href="#" class="mobile-menu-link mobile-nav-link">TRANG CHỦ</a>
                    <a href="homestay.html" class="mobile-menu-link mobile-nav-link">HOMESTAYS</a>
                    <a href="about.html" class="mobile-menu-link mobile-nav-link">VỀ CHÚNG TÔI</a>
                    <a href="contact.html" class="mobile-menu-link mobile-nav-link">LIÊN HỆ</a>
                    <hr class="mobile-menu-divider" />
                    <a href="partnership.html" class="mobile-menu-link">Hợp tác với chúng tôi</a>
                    <button class="mobile-menu-btn" onclick="openPopup('register'); closeMobileMenu();">Đăng ký</button>
                    <button class="mobile-menu-btn" onclick="openPopup('login'); closeMobileMenu();">Đăng nhập</button>
                </div>
            </div>
        </header>

        <!-- <div class="hero">
            <div class="search-box">
                <div class="date-picker">
                    <input type="date" class="date1" />
                    <input type="date" class="date2" />
                </div>
                <button class="search-button">TÌM KIẾM</button>
            </div>
            <nav class="nav">
              <ul>
                <li><a href="trang-chu.html">TRANG CHỦ</a></li>
                <li><a href="homestay.html">HOMESTAYS</a></li>
                <li><a href="about.html">VỀ CHÚNG TÔI</a></li>
                <li><a href="contact.html">LIÊN HỆ</a></li>
              </ul>
            </nav>
          </div>
        </div> -->

        <div class="btns desktop-btns" id="auth-buttons">
          <button
            class="cooperate-btn"
            onclick="location.href='partnership.html'"
          >
            Hợp tác với chúng tôi
          </button>
          <button class="dang-ky-btn signup" id="registerBtn">Đăng ký</button>
          <button class="dang-nhap-btn login" id="loginBtn">Đăng nhập</button>
        </div>

        <div
          id="user-info"
          class="user-dropdown"
          style="display: none; position: relative"
        >
          <img src="/assets/img/icon/user.svg" alt="user-icon" id="user-icon" />
          <div id="user-menu" class="dropdown-menu">
            <a href="profile.html" class="dropdown-item">Hồ sơ</a>
            <a href="homestay.html" class="dropdown-item">Homestay</a>
            <button id="logoutBtn" class="dropdown-item">Đăng xuất</button>
          </div>
        </div>

        <button
          class="mobile-menu-toggle"
          aria-label="Toggle menu"
          aria-expanded="false"
        >
          <i class="ti-menu"></i>
        </button>

        <div class="mobile-menu">
          <a href="#" class="mobile-menu-link mobile-nav-link">TRANG CHỦ</a>
          <a href="homestay.html" class="mobile-menu-link mobile-nav-link"
            >HOMESTAYS</a
          >
          <a href="about.html" class="mobile-menu-link mobile-nav-link"
            >VỀ CHÚNG TÔI</a
          >
          <a href="contact.html" class="mobile-menu-link mobile-nav-link"
            >LIÊN HỆ</a
          >
          <hr class="mobile-menu-divider" />
          <a href="partnership.html" class="mobile-menu-link"
            >Hợp tác với chúng tôi</a
          >
          <button
            class="mobile-menu-btn"
            onclick="openPopup('register'); closeMobileMenu();"
          >
            Đăng ký
          </button>
          <button
            class="mobile-menu-btn"
            onclick="openPopup('login'); closeMobileMenu();"
          >
            Đăng nhập
          </button>
        </div>
      </div>
    </header>

    <div class="hero">
      <div class="search-box">
        <div class="date-picker">
          <input type="date" id="checkInDate" class="date1" />
          <input type="date" id="checkOutDate" class="date2" />
        </div>
        <button class="search-button">TÌM KIẾM</button>
      </div>
    </div>

    <!-- Nội dung chính -->
    <main class="room-detail">
      <!-- Ảnh + chọn phòng -->
      <section class="top-section">
        <div class="gallery-grid">
          <div class="gallery-large">
            <img src="assets/img/room1.webp" alt="Ảnh lớn" />
            <a class="view-all-btn" href="#">
              <i class="ti-camera"></i> Xem mọi bức ảnh
            </a>
          </div>
          <div class="gallery-small">
            <img src="assets/img/room2.webp" alt="Ảnh nhỏ 1" />
            <img src="assets/img/room3.webp" alt="Ảnh nhỏ 2" />
            <img src="assets/img/room4.webp" alt="Ảnh nhỏ 3" />
            <img src="assets/img/room5.webp" alt="Ảnh nhỏ 4" />
          </div>
        </div>

        <div class="top-nav-price-box">
          <div class="tab-links">
            <a href="#overview">Tổng quan</a>
            <a href="#room-list">Phòng nghỉ</a>
            <a href="#facilities">Cơ sở vật chất</a>
            <a href="#hotel-facts">Đánh giá</a>
            <a href="#location">Vị trí</a>
          </div>
          <div class="tab-price-action">
            <span class="label">Từ</span>
            <p class="price"><span id="min-price">---</span> VND/đêm</p>
            <button class="btn-book-now">Đặt ngay</button>
          </div>
        </div>
      </section>

      <!-- Thông tin mô tả -->
      <section class="info-section">
        <section class="overview" id="overview">
          <h2 class="homestay-name" id="homestay-name"></h2>
          <p class="address" id="homestay-address"></p>
          <p class="desc" id="homestay-description"></p>
        </section>

        <section class="homestay-review" id="homestay-review">
          <h3>Đánh giá về Homestay của chúng tôi</h3>
        
          <!-- Danh sách đánh giá -->
          <div class="review-list" id="review-list">

          </div>
        
          <!-- Form đánh giá -->
          <div class="review-form">
            <h4>Viết đánh giá của bạn</h4>
            <form id="submit-review-form">
              <label for="rating">Số sao:</label>
              <select id="rating" name="rating" required>
                <option value="">-- Chọn số sao --</option>
                <option value="5">★★★★★</option>
                <option value="4">★★★★</option>
                <option value="3">★★★</option>
                <option value="2">★★</option>
                <option value="1">★</option>
              </select>
        
              <label for="comment">Nhận xét:</label>
              <textarea id="comment" name="comment" rows="4" placeholder="Hãy chia sẻ trải nghiệm của bạn..." required></textarea>
        
              <button type="submit">Gửi đánh giá</button>
            </form>
          </div>
        </section>
        
        
      </section>
      <section class="room-list" id="room-list">
        <h3>Phòng còn trống tại đây</h3>
        <!-- <div class="room-item">
          <div class="room-img">
            <img src="assets/img/standard-double.webp" alt="Standard Double" />
          </div>
          <div class="room-facilities">
            <h4>Tiện nghi</h4>
            <div class="facilities-list">
              <div class="facility-item">
                <i class="ti-check"></i> Giường cỡ king
              </div>
              <div class="facility-item">
                <i class="ti-check"></i> Gồm bữa sáng
              </div>
              <div class="facility-item">
                <i class="ti-check"></i> Wi-Fi miễn phí
              </div>
              <div class="facility-item"><i class="ti-check"></i> Điều hòa</div>
              <div class="facility-item">
                <i class="ti-check"></i> Phòng tắm riêng
              </div>
            </div>
          </div>
          <div class="room-price">
            <p class="price">461.837 VND/đêm</p>
          </div>
          <div class="room-booking">
            <button class="btn-book-now">Đặt ngay</button>
          </div>
        </div> -->
      </section>
    </main>
  </body>
  <div id="popup-placeholder"></div>
  <script type="module">

    const lastDates = JSON.parse(localStorage.getItem('lastSearchDates'));
    if (lastDates) {
    document.getElementById('checkInDate').value = lastDates.checkIn;
    document.getElementById('checkOutDate').value = lastDates.checkOut;
}

    document.querySelector(".search-button").addEventListener("click", function () {
    const checkInDate = document.querySelector(".date1").value;
    const checkOutDate = document.querySelector(".date2").value;
    const today = new Date().toISOString().split("T")[0];

    if (!checkInDate || !checkOutDate) {
        alert("Vui lòng chọn ngày nhận và trả phòng.");
        return;
    }

    if (checkInDate <= today) {
        alert("Ngày nhận phòng không hợp lệ.");
        return;
    }

    if (checkOutDate <= checkInDate) {
        alert("Ngày trả phòng phải sau ngày nhận phòng.");
        return;
    }
});
  </script>

  <script type="module">
    import { setupPopupEventListeners } from "./assets/js/popup-login.js";

    fetch("popup.html")
      .then((response) => response.text())
      .then((data) => {
        document.getElementById("popup-placeholder").innerHTML = data;
        setupPopupEventListeners();
      });
  </script>
  <script type="module" src="assets/js/main.js"></script>
  <script type="module">
    function decodeJWT(token) {
      const base64Url = token.split(".")[1];
      const base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
      const payload = JSON.parse(
        decodeURIComponent(
          atob(base64)
            .split("")
            .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
            .join("")
        )
      );
      return payload;
    }

    window.onload = function () {
      const searchBtn = document.querySelector(".search-button");
      const checkInInput = document.querySelector(".date1");
      const checkOutInput = document.querySelector(".date2");
      const roomListSection = document.getElementById("room-list");
      const roomContainer = document.createElement("div");
      roomContainer.classList.add("room-items");
      roomListSection.appendChild(roomContainer);

      searchBtn.addEventListener("click", () => {
        const checkInDate = checkInInput.value;
        const checkOutDate = checkOutInput.value;
        const urlParams = new URLSearchParams(window.location.search);
        const homestayId = urlParams.get("id"); // Trích xuất giá trị 'id'


// Kiểm tra nếu homestayId không tồn tại
if (!homestayId) {
    alert("Không tìm thấy ID của homestay.");
    return;
}
        if (!checkInDate || !checkOutDate) {
          alert("Vui lòng chọn ngày nhận và trả phòng.");
          return;
        }
        fetch(
          `http://localhost:8080/homestay/api/rooms/available?homestayId=${homestayId}&checkInDate=${checkInDate}&checkOutDate=${checkOutDate}`
        )
          .then((res) => res.json())
          .then((data) => {
            roomContainer.innerHTML = "";

            if (!data.length) {
              roomContainer.innerHTML =
                "<p>Không có phòng trống trong thời gian này.</p>";
              return;
            }

            data.forEach((r) => {
              const item = document.createElement("div");
              item.classList.add("room-item");
              item.dataset.roomId = r.roomId;

              item.innerHTML = `
                <div class="room-img">
                  <img src="assets/img/standard-double.webp" alt="Room Image" />
                </div>
                <div class="room-facilities">
                  <h4>Tiện nghi</h4>
                  <div class="facilities-list">
                    ${
                      typeof r.features === "string"
                        ? r.features
                            .split(",")
                            .map(
                              (a) =>
                                `<div class="facility-item"><i class="ti-check"></i> ${a.trim()}</div>`
                            )
                            .join("")
                        : "<div class='facility-item'>Không có thông tin</div>"
                    }
                  </div>
                </div>
                <div class="room-price">
                  <p class="price">${r.price.toLocaleString(
                    "vi-VN"
                  )} VND/đêm</p>
                </div>
                <div class="room-booking">
                  <button class="btn-book-now" data-room-id="${
                    r.roomId
                  }">Đặt ngay</button>
                </div>
              `;

              roomContainer.appendChild(item);
            });

            attachBookingHandlers();
          })
          .catch((err) => {
            console.error("Lỗi khi lấy phòng:", err);
            alert("Không thể tải danh sách phòng.");
          });
      });

      function attachBookingHandlers() {
  document.querySelectorAll(".btn-book-now").forEach((btn) => {
    btn.addEventListener("click", () => {
      const token = localStorage.getItem("authToken");
      if (!token) {
        alert("Vui lòng đăng nhập để đặt phòng.");
        return;
      }

      const payload = decodeJWT(token);
      const userId = payload.host_id || payload.sub || payload.userId;
      const roomId = btn.dataset.roomId;
      const checkInDate = checkInInput.value;
      const checkOutDate = checkOutInput.value;

      if (!checkInDate || !checkOutDate) {
        alert("Vui lòng chọn ngày nhận và trả phòng.");
        return;
      }

      const body = {
        // userId: Number(userId),
        roomId: Number(roomId),
        checkInDate,
        checkOutDate,
      };

      fetch("http://localhost:8080/homestay/api/bookings", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
        body: JSON.stringify(body),
      })
        .then((res) => {
          if (!res.ok) throw new Error("Đặt phòng thất bại");
          return res.json();
        })
        .then((data) => {
          alert("Đặt phòng thành công!");
          window.timer = null;

          // Lấy giá từ biến `r.price` hoặc truyền từ nơi gọi
          const roomPrice = data.price || 1000000; // hoặc lấy từ object `r` nếu có
          
          fetch("http://localhost:8080/homestay/api/payment/vnpay?amount=1000000&bankCode=NCB",{
            method: "GET",
          headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${token}`,
        },
          })
            .then((res) => {
              if (!res.ok) throw new Error("Không thể tạo đơn thanh toán");
              return res.json();
            })
            .then((paymentData) => {
              const paymentUrl = paymentData.data.paymentUrl;
              if (paymentUrl) {
                window.location.href = paymentUrl;
              } else {
                alert("Không lấy được đường dẫn thanh toán.");
              }
            })
            .catch((err) => {
              console.error("Lỗi tạo thanh toán:", err);
              alert("Đặt phòng thành công nhưng lỗi khi tạo thanh toán.");
            });
        })
        .catch((err) => {
          console.error("Lỗi đặt phòng:", err);
          alert("Không thể đặt phòng.");
        });
    });
  });
}};
  </script>
    <script type="module" src="assets/js/review-and-info.js"></script>
    <script type="module" src="assets/js/main.js"></script>
    <script type="module" src="assets/js/role-redirect.js"></script>
</html>
